<% content_for :head do %>
  <%= pagy_seo_tags(@pagy) %>
<% end %>

<div class="mb-8 flex flex-col sm:flex-row items-center justify-between gap-4">
  <h1 class="text-3xl font-bold">Benutzer</h1>
  <div class="text-sm text-gray-500">
    <%= @pagy.count %> <%= User.model_name.human(count: @pagy.count) %> gefunden
  </div>
</div>

<!-- Search Bar -->
<div class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
  <%= form_with url: users_path, method: :get, class: "flex flex-col sm:flex-row gap-4 items-end", data: { turbo_frame: "_top" } do |f| %>
    <%# Preserve sort params %>
    <%= f.hidden_field :sort, value: params[:sort] if params[:sort] %>
    <%= f.hidden_field :direction, value: params[:direction] if params[:direction] %>

    <div class="flex flex-col gap-1 flex-1">
      <%= f.label :q, "Suche", class: "label-field mb-0" %>
      <div class="relative">
        <%= f.text_field :q, value: params[:q], placeholder: "Benutzername...", class: "input-field py-1.5 text-sm pl-8" %>
        <i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
      </div>
    </div>

    <div class="flex items-center gap-2 pb-1">
      <%= f.check_box :moderators_only, { checked: params[:moderators_only] == "1", class: "rounded border-gray-300 text-cs-gold focus:ring-cs-gold" }, "1", "0" %>
      <%= f.label :moderators_only, "Nur Admins / Moderatoren", class: "text-sm text-gray-700 cursor-pointer" %>
    </div>

    <div class="flex gap-2">
      <%= f.submit "Suchen", class: "btn btn-primary btn-sm h-[34px]" %>
      <% if params[:q].present? || params[:moderators_only] == "1" %>
        <%= link_to "Zurücksetzen", users_path(params.permit(:sort, :direction)), class: "btn btn-secondary btn-sm h-[34px]" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Sort Bar -->
<div class="mb-6 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100">
  <span class="font-medium text-gray-900">Sortieren:</span>
  <%= sortable "username", "Benutzername" %>
  <%= sortable "user_stats.points", "Punkte" %>
  <%= sortable "last_active_at", "Zuletzt aktiv" %>
  <%= sortable "created_at", "Registriert seit" %>
</div>

<% if @pagy.pages > 1 %>
  <div class="flex justify-center mb-6">
    <%== @pagy.series_nav %>
  </div>
<% end %>

<!-- Desktop Table View -->
<div class="hidden md:block">
  <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Benutzer
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Rolle
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Punkte
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Zuletzt aktiv
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Registriert seit
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @users.each do |user| %>
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <%= user_badge(user) %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <%= render 'users/role_badges', user: user, inline: true %>
              <% unless user.roles.any? %>
                <span class="text-sm text-gray-400">-</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">
                <%= number_with_delimiter(user.points) %>
              </div>
              <div class="text-xs text-gray-500">
                Rang <%= user.rank %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                <% if user.last_active_at %>
                  <%= time_ago_in_words(user.last_active_at) %> her
                <% else %>
                  <span class="text-gray-400">Noch nie</span>
                <% end %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                <%= user.created_at.strftime("%d. %b %Y") %>
              </div>
              <div class="text-xs text-gray-500">
                <%= time_ago_in_words(user.created_at) %> her
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Mobile Card View -->
<div class="md:hidden space-y-4">
  <% @users.each do |user| %>
    <div class="card hover:shadow-md transition-all duration-200">
      <div class="card-body p-4">
        <div class="flex items-start justify-between mb-3">
          <div class="flex-1">
            <%= user_badge(user) %>
            <div class="mt-2">
              <%= render 'users/role_badges', user: user %>
            </div>
          </div>
          <div class="text-right">
            <div class="text-lg font-bold text-gray-900">
              <%= number_with_delimiter(user.points) %>
            </div>
            <div class="text-xs text-gray-500">
              Punkte
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-xs text-gray-500 mb-1">Rang</div>
            <div class="font-medium text-gray-900"><%= user.rank %></div>
          </div>

          <div>
            <div class="text-xs text-gray-500 mb-1">Registriert</div>
            <div class="font-medium text-gray-900">
              <%= user.created_at.strftime("%d. %b %Y") %>
            </div>
          </div>

          <div class="col-span-2">
            <div class="text-xs text-gray-500 mb-1">Zuletzt aktiv</div>
            <div class="font-medium text-gray-900">
              <% if user.last_active_at %>
                <%= time_ago_in_words(user.last_active_at) %> her
              <% else %>
                <span class="text-gray-400">Noch nie</span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if @users.empty? %>
  <div class="card p-12 text-center bg-gray-50 border-dashed border-2 border-gray-200">
    <div class="text-gray-300 mb-4">
      <i class="fas fa-users text-5xl"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-800 mb-2">Keine Benutzer gefunden</h3>
    <p class="text-gray-500 mb-8 max-w-md mx-auto">Leider konnten wir keine Benutzer finden, die deiner Suche entsprechen.</p>
    <%= link_to "Zurücksetzen", users_path, class: "btn btn-primary" %>
  </div>
<% end %>

<% if @pagy.pages > 1 %>
  <div class="flex justify-center py-8">
    <%== @pagy.series_nav %>
  </div>
<% end %>
