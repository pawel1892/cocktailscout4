<% content_for :head do %>
  <%= pagy_seo_tags(@pagy) %>
<% end %>

<div class="mb-8 flex flex-col sm:flex-row items-center justify-between gap-4">
  <h1 class="text-3xl font-bold">Rezepte</h1>
  <div class="text-sm text-gray-500">
    <%= @pagy.count %> <%= Recipe.model_name.human(count: @pagy.count) %> gefunden
  </div>
</div>

<!-- Filter Bar -->
<% if active_filters.any? %>
  <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg flex flex-wrap items-center gap-3">
    <span class="font-medium text-green-900">Aktive Filter:</span>
    <% active_filters.each do |filter| %>
      <span class="bg-white text-green-800 border border-green-200 px-2 py-1 rounded text-sm flex items-center gap-2 shadow-sm">
        <%= filter[:label] %>
        <%= link_to recipes_path(params.permit(:sort, :direction, :q, :min_rating, :tag, :ingredient_id, :user_id, :collection_id, :filter).except(filter[:param])), class: "text-green-600 hover:text-green-800" do %>
          <i class="fas fa-times"></i>
        <% end %>
      </span>
    <% end %>
    <%= link_to "Alle Filter zurücksetzen", recipes_path(params.permit(:sort, :direction)), class: "text-sm text-green-700 hover:text-green-900 underline ml-auto" %>
  </div>
<% end %>

<div class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
  <%= form_with url: recipes_path, method: :get, class: "flex flex-wrap gap-4 items-end", data: { turbo_frame: "_top" } do |f| %>
    <%# Preserve sort params %>
    <%= f.hidden_field :sort, value: params[:sort] if params[:sort] %>
    <%= f.hidden_field :direction, value: params[:direction] if params[:direction] %>

    <div class="flex flex-col gap-1 min-w-[200px] flex-1">
      <%= f.label :q, "Suche", class: "label-field mb-0" %>
      <div class="relative">
        <%= f.text_field :q, value: params[:q], placeholder: "Rezeptname...", class: "input-field py-1.5 text-sm pl-8" %>
        <i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
      </div>
    </div>

    <div class="flex flex-col gap-1 min-w-[150px] flex-1">
      <%= f.label :min_rating, "Mindestbewertung", class: "label-field mb-0" %>
      <%= f.select :min_rating, 
          options_for_select([["Alle", ""], ["5+", 5], ["6+", 6], ["7+", 7], ["8+", 8], ["9+", 9]], params[:min_rating]), 
          {}, 
          class: "input-field py-1.5 text-sm" 
      %>
    </div>

    <div class="flex flex-col gap-1 min-w-[150px] flex-1">
      <%= f.label :tag, "Kategorie / Tag", class: "label-field mb-0" %>
      <%= f.collection_select :tag, @tags, :name, :name, 
          { include_blank: "Alle" }, 
          { class: "input-field py-1.5 text-sm", value: params[:tag] } 
      %>
    </div>

    <div class="flex flex-col gap-1 min-w-[150px] flex-1">
      <%= f.label :ingredient_id, "Zutat", class: "label-field mb-0" %>
      <%= f.collection_select :ingredient_id, @ingredients, :id, :name,
          { include_blank: "Alle" },
          { class: "input-field py-1.5 text-sm", value: params[:ingredient_id] }
      %>
    </div>

    <div class="flex flex-col gap-1 min-w-[150px] flex-1">
      <label class="label-field mb-0">Benutzer</label>
      <user-autocomplete
        initial-username="<%= @filter_user&.username %>"
        initial-user-id="<%= params[:user_id] %>"
      ></user-autocomplete>
    </div>

    <% if @collections.any? %>
      <div class="flex flex-col gap-1 min-w-[200px] flex-1">
        <%= f.label :collection_id, "Meine Liste", class: "label-field mb-0" %>
        <%= f.collection_select :collection_id, @collections, :id, :name,
            { include_blank: "Alle Rezepte" },
            { class: "input-field py-1.5 text-sm", value: params[:collection_id] }
        %>
      </div>
    <% end %>

    <% if Current.user %>
      <div class="flex flex-col gap-1 min-w-[150px] flex-1">
        <label class="label-field mb-0">&nbsp;</label>
        <label class="inline-flex items-center gap-2 cursor-pointer py-1.5 px-3 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors h-[34px]">
          <%= f.check_box :filter, { checked: params[:filter] == "favorites", onchange: "this.form.submit()", class: "hidden" }, "favorites", "" %>
          <i class="<%= params[:filter] == 'favorites' ? 'fas text-red-600' : 'far text-gray-400' %> fa-heart"></i>
          <span class="<%= params[:filter] == 'favorites' ? 'font-medium text-gray-900' : 'text-gray-600' %> text-sm select-none">Nur Favoriten</span>
        </label>
      </div>
    <% end %>

    <div class="flex gap-2">
      <%= f.submit "Filtern", class: "btn btn-primary btn-sm h-[34px]" %>
    </div>
  <% end %>
</div>

<!-- Sort Bar -->
<div class="mb-6 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100">
  <span class="font-medium text-gray-900">Sortieren:</span>
  <%= sortable "title", Recipe.human_attribute_name(:title) %>
  <%= sortable "average_rating", Recipe.human_attribute_name(:average_rating) %>
  <%= sortable "users.username", Recipe.human_attribute_name(:user) %>
  <%= sortable "alcohol_content", Recipe.human_attribute_name(:alcohol_content) %>
  <%= sortable "visits_count", Recipe.human_attribute_name(:visits_count) %>
</div>

<% if @pagy.pages > 1 %>
  <div class="flex justify-center mb-6">
    <%== @pagy.series_nav %>
  </div>
<% end %>

<div class="space-y-4">
  <% if @recipes.any? %>
    <% @recipes.each do |recipe| %>
      <div class="card hover:shadow-md transition-all duration-200 group">
        <div class="card-body p-4">
          <div class="flex gap-4">
            <!-- Thumbnail -->
            <div class="flex-shrink-0">
               <%= link_to recipe_path(recipe) do %>
                 <%= recipe_thumbnail(recipe, size_class: "w-20 h-20 sm:w-24 sm:h-24") %>
               <% end %>
            </div>

            <!-- Content -->
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start gap-2">
                 <div class="min-w-0 flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <%= link_to recipe.title, recipe_path(recipe), class: "link font-bold text-lg leading-tight truncate group-hover:text-cs-gold transition-colors" %>
                      <favorite-toggle
                        favoritable-type="Recipe"
                        :favoritable-id="<%= recipe.id %>"
                        :initial-favorited="<%= @favorite_recipe_ids.include?(recipe.id) ? 'true' : 'false' %>"
                        size="text-lg"
                      ></favorite-toggle>
                    </div>
                    <div class="text-xs text-gray-500 mb-2 flex flex-wrap items-center gap-1">
                      <span>von</span>
                      <%= user_badge(recipe.user) %>
                    </div>
                 </div>
                 <div class="flex flex-col items-center gap-1">
                   <div class="<%= rating_badge_class(recipe.average_rating) %> px-2 py-1 md:px-3 md:py-2 md:text-lg rounded text-sm font-bold whitespace-nowrap min-w-[3rem] md:min-w-[4rem] text-center">
                      <%= number_with_precision(recipe.average_rating, precision: 1, separator: ",") %>
                   </div>
                   <span class="text-[10px] text-gray-400 font-normal">(<%= recipe.ratings_count %>)</span>
                 </div>
              </div>

                          <% if recipe.tag_list.any? %>
                              <%= render "recipes/tag_list", tags: recipe.tags %>
                          <% end %>
              <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-gray-400 mt-2">
                 <% if recipe.alcohol_content.present? %>
                   <span title="<%= Recipe.human_attribute_name(:alcohol_content) %>" class="flex items-center gap-1">
                     <i class="fas fa-wine-glass-alt"></i> <%= number_to_percentage recipe.alcohol_content, precision: 1 %>
                   </span>
                 <% end %>
                 <span title="<%= Recipe.human_attribute_name(:visits_count) %>" class="flex items-center gap-1">
                   <i class="far fa-eye"></i> <%= number_with_delimiter recipe.visits_count %>
                 </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="card p-12 text-center bg-gray-50 border-dashed border-2 border-gray-200">
      <div class="text-gray-300 mb-4">
        <i class="fas fa-search text-5xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Keine Rezepte gefunden</h3>
      <p class="text-gray-500 mb-8 max-w-md mx-auto">Leider konnten wir keine Rezepte finden, die deinen Filtereinstellungen entsprechen. Versuche es mit weniger Filtern oder anderen Kriterien.</p>
      <%= link_to "Alle Filter zurücksetzen", recipes_path(params.permit(:sort, :direction)), class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<% if @pagy.pages > 1 %>
  <div class="flex justify-center py-8">
    <%== @pagy.series_nav %>
  </div>
<% end %>
