<% content_for :head do %>
  <%= recipe_structured_data(@recipe) %>
<% end %>

<!-- Draft Indicator -->
<% if @recipe.draft? %>
  <div class="callout callout-gold mb-4">
    <i class="fas fa-file-alt"></i>
    <strong>Entwurf:</strong> Dieses Rezept ist noch nicht veröffentlicht und nur für dich sichtbar.
  </div>
<% end %>

<!-- Title -->
<div class="mb-6 flex items-start justify-between gap-4">
  <div class="min-w-0 flex-1">
    <h1 class="text-3xl md:text-4xl font-bold mb-2 break-words"><%= @recipe.title %></h1>
    <!-- Tags -->
    <%= render "recipes/tag_list", tags: @recipe.tags %>

  </div>

  <div class="flex-shrink-0 pt-1">
    <favorite-toggle
      favoritable-type="Recipe"
      :favoritable-id="<%= @recipe.id %>"
      :initial-favorited="<%= (Current.user && Current.user.favorites.exists?(favoritable: @recipe)) ? 'true' : 'false' %>"
    ></favorite-toggle>
  </div>
</div>

<!-- Stats Bar -->
<div class="card mb-6">
  <div class="card-body p-4">
    <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 items-start sm:justify-between">
      <!-- Left: Rating Control -->
      <div class="flex-1 w-full sm:w-auto min-w-0">
        <rating-control
          rateable-type="Recipe"
          :rateable-id="<%= @recipe.id %>"
          :initial-average="<%= @recipe.average_rating || 0 %>"
          :initial-count="<%= @recipe.ratings_count || 0 %>"
          :user-rating="<%= (Current.user && @recipe.ratings.find_by(user: Current.user)&.score) || 'null' %>"
        ></rating-control>
      </div>

      <!-- Right: All Stats -->
      <div class="text-left sm:text-right text-sm space-y-2 w-full sm:w-auto">
        <!-- Author -->
        <div class="flex items-center sm:justify-end gap-1 text-gray-600">
          <span>von</span>
          <%= user_badge(@recipe.user) %>
        </div>

        <!-- Views -->
        <div class="text-xs text-gray-400 flex items-center sm:justify-end gap-3">
          <span><i class="far fa-eye"></i> <%= number_with_delimiter(@recipe.visits_count) %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image & Ingredients Section -->
<% show_image_col = @recipe.approved_recipe_images.any? || Current.user %>
<div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- Image column -->
  <% if show_image_col %>
    <div class="md:col-span-1 md:order-2">
      <% if @recipe.approved_recipe_images.any? %>
        <recipe-image-gallery></recipe-image-gallery>
        <% if Current.user %>
          <div class="mt-2 text-center">
            <%= link_to bilder_recipe_path(@recipe), class: "btn btn-outline btn-sm" do %>
              <i class="fas fa-camera mr-1"></i> Bild hochladen
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="card h-full flex flex-col items-center justify-center py-10 px-4 text-center">
          <i class="fas fa-camera text-4xl text-gray-300 mb-3"></i>
          <p class="text-gray-500 text-sm mb-4">Noch keine Fotos vorhanden</p>
          <%= link_to bilder_recipe_path(@recipe), class: "btn btn-outline btn-sm" do %>
            <i class="fas fa-camera mr-1"></i> Bild hochladen
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Ingredients (2 columns on md+ when image col present, full width otherwise) -->
  <div class="<%= show_image_col ? 'md:col-span-2 md:order-1' : 'md:col-span-3' %>">
    <recipe-scaling
      recipe-slug="<%= @recipe.slug %>"
      :scalable="<%= @recipe.has_scalable_ingredients? %>"
      :initial-ingredients='<%= raw @recipe.recipe_ingredients.map { |ri|
        {
          id: ri.id,
          amount: ri.amount,
          unit_name: ri.unit&.name,
          unit_display_name: ri.unit&.display_name,
          ingredient_name: ri.formatted_ingredient_name,
          ingredient_plural_name: ri.ingredient.plural_name,
          formatted_amount: ri.formatted_amount,
          additional_info: ri.additional_info,
          is_scalable: ri.is_scalable,
          is_optional: ri.is_optional,
          needs_review: ri.needs_review,
          old_description: ri.old_description
        }
      }.to_json %>'
      :initial-alcohol-info='<%= raw({
        total_volume_ml: @recipe.total_volume_in_ml.round(1),
        alcohol_volume_ml: @recipe.alcohol_volume_in_ml.round(1),
        alcohol_content_percent: @recipe.calculate_alcohol_content
      }.to_json) %>'
    ></recipe-scaling>
  </div>
</div>

<% if @recipe.approved_recipe_images.any? %>
  <% content_for :head do %>
    <script>
      window.recipeImages = <%= raw @recipe.approved_recipe_images.shuffle.map { |image|
        {
          id: image.id,
          mediumUrl: url_for(recipe_image_url(image, style: :medium)),
          largeUrl: url_for(recipe_image_url(image, style: :large)),
          userBadge: user_badge(image.user),
          uploadDate: l(image.created_at.to_date)
        }
      }.to_json %>;
    </script>
  <% end %>
<% end %>

<!-- Preparation / Description -->
<% if @recipe.description.present? %>
  <div class="card mb-6">
    <div class="card-body p-4 sm:p-6">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-cocktail text-cs-gold"></i>
        Zubereitung
      </h2>
      <div class="prose prose-cs max-w-none">
        <%= render_markdown(@recipe.description) %>
      </div>
    </div>
  </div>
<% end %>

<!-- Comments -->
<% content_for :head do %>
  <script>
    window.recipeComments = <%= raw @comments_json %>;
    window.recipeCommentsMeta = { isModerator: <%= Current.user&.can_moderate_recipe? ? 'true' : 'false' %> };
  </script>
<% end %>
<recipe-comments recipe-slug="<%= @recipe.slug %>"></recipe-comments>
